# Reflection: CQST-010 - DDD Refactoring: UserProgress Domain Events & Event Sourcing

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-26  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2025-12-28  
**–î–∞—Ç–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:** 2025-12-28  
**Complexity Level:** 3-4 (Intermediate to Complex Feature)  
**Actual Time:** ~10 —á–∞—Å–æ–≤ (Estimated: 9-12 —á–∞—Å–æ–≤) ‚úÖ

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–ó–∞–¥–∞—á–∞ CQST-010 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–ª–∞ —Å–æ–±–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥–æ–º–µ–Ω–∞ UserProgress —Å –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º Domain Events –∏ Event Store –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ DDD.

**–û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è Event Sourcing –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ `src/Shared/`
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 6 –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∫–≤–µ—Å—Ç–∞
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Event Store —Å DBAL –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω PlatformResolver –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏: 19 (12 unit + 7 integration)
- ‚úÖ –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø–ª–∞–Ω–∞ (10—á –∏–∑ 9-12—á)

**–ë–æ–Ω—É—Å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- PlatformResolver (219 —Å—Ç—Ä–æ–∫) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- Platform Value Object - —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- Comprehensive documentation (README.md, 153 —Å—Ç—Ä–æ–∫–∏)

---

## ‚úÖ –ß—Ç–æ –ø—Ä–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ

### 1. –§–∞–∑–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–±–∏–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ 4 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ–∞–∑—ã –æ–±–µ—Å–ø–µ—á–∏–ª–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –§–ê–ó–ê 1 (Shared): –°–æ–∑–¥–∞–Ω–∞ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –§–ê–ó–ê 2 (Events): 6 —Å–æ–±—ã—Ç–∏–π —Å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –§–ê–ó–ê 3 (Event Store): –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π –ë–î
- –§–ê–ó–ê 4 (Integration): –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑ breaking changes

**–ü–æ—á–µ–º—É —Å—Ä–∞–±–æ—Ç–∞–ª–æ:**
- –ß—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏
- –ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –∑–∞–≤–µ—Ä—à–∞–ª–∞—Å—å —Ç–µ—Å—Ç–∞–º–∏
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –±—ã–ª–∏ —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞

**–†–µ—à–µ–Ω–∏–µ:** `AbstractUserQuestProgressEvent` –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–ª –æ–±—â—É—é –ª–æ–≥–∏–∫—É –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ò–∑–±–µ–∂–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ (DRY principle)
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π (aggregateId, userId, questId, occurredAt, platform)
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ –±—É–¥—É—â–µ–º

**–ö–æ–¥:**
```php
abstract class AbstractUserQuestProgressEvent implements DomainEventInterface
{
    public function __construct(
        protected Uuid $aggregateId,
        protected Uuid $userId,
        protected Uuid $questId,
        protected ?DateTimeImmutable $occurredAt = null,
        protected ?Platform $platform = null
    ) {
        $this->occurredAt = $occurredAt ?? new DateTimeImmutable();
    }
    // ... –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
}
```

### 3. RecordsEvents trait - —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:** Trait –≤–º–µ—Å—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê–≥—Ä–µ–≥–∞—Ç—ã –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –±–∞–∑–æ–≤–æ–º—É –∫–ª–∞—Å—Å—É
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å trait –≤ –ª—é–±—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–∞—Ö
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ API: `apply()` –¥–ª—è –∑–∞–ø–∏—Å–∏, `pull()` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–¥ trait: 28 —Å—Ç—Ä–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤: UserQuestProgress (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –∞–≥—Ä–µ–≥–∞—Ç–∞—Ö)
- –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: 4 unit —Ç–µ—Å—Ç–∞

### 4. DBAL –≤–º–µ—Å—Ç–æ Doctrine ORM –¥–ª—è Event Store

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ DBAL –¥–ª—è Event Store.

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –°–æ–±—ã—Ç–∏—è - immutable data structures, –Ω–µ —Ç—Ä–µ–±—É—é—Ç ORM
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –Ω–µ—Ç overhead –æ—Ç hydration
- –ü—Ä–æ—Å—Ç–æ—Ç–∞: INSERT + SELECT, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤

**Performance:**
- INSERT —Å–æ–±—ã—Ç–∏—è: ~1-2ms
- SELECT –ø–æ aggregate_id: ~5-10ms (—Å –∏–Ω–¥–µ–∫—Å–æ–º)

### 5. Platform tracking —á–µ—Ä–µ–∑ Value Object

**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ PlatformResolver + Platform VO.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Platform –≤–º–µ—Å—Ç–æ array)
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ web, iOS, Android –∏–∑ –∫–æ—Ä–æ–±–∫–∏

**–ë–æ–Ω—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–∞—Ö (Quest, User).

### 6. Comprehensive testing strategy

**Unit —Ç–µ—Å—Ç—ã (12):**
- RecordsEvents trait: 4 —Ç–µ—Å—Ç–∞
- Domain Events: 8 —Ç–µ—Å—Ç–æ–≤ (–≤—Å–µ 6 —Å–æ–±—ã—Ç–∏–π + platform + eventData)

**Integration —Ç–µ—Å—Ç—ã (7):**
- DoctrineProgressEventStore: –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞–≥—Ä–µ–≥–∞—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100% pass rate, 0 regression bugs.

### 7. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π

**README.md (153 —Å—Ç—Ä–æ–∫–∏):**
- –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é

**–¶–µ–Ω–Ω–æ—Å—Ç—å:** –ù–æ–≤—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å Event Sourcing –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.

---

## ‚ö†Ô∏è –í—ã–∑–æ–≤—ã –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `occurred_at` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ —Å–æ–±—ã—Ç–∏–π (—Ä–µ—à–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ø–ª–∞–Ω–µ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –ù–ï –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å `occurred_at`, –Ω–æ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –ø–æ–ª–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

**–†–µ—à–µ–Ω–∏–µ:** 
- –î–æ–±–∞–≤–ª–µ–Ω `occurred_at` —Å default –∑–Ω–∞—á–µ–Ω–∏–µ–º `new DateTimeImmutable()`
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è–º –±—ã—Ç—å self-contained
- –í Event Store –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `occurred_at` –∏–∑ —Å–æ–±—ã—Ç–∏—è (–Ω–µ `recorded_at` –∏–∑ –ë–î)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```php
public function __construct(
    // ...
    protected ?DateTimeImmutable $occurredAt = null,
    protected ?Platform $platform = null
) {
    $this->occurredAt = $occurredAt ?? new DateTimeImmutable();
}
```

**Lesson:** –î–æ–º–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –ë–î –µ—Å—Ç—å `recorded_at`.

### 2. Platform –∫–∞–∫ optional –ø–∞—Ä–∞–º–µ—Ç—Ä

**–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:** –í—Å–µ –º–µ—Ç–æ–¥—ã –∞–≥—Ä–µ–≥–∞—Ç–∞ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å `array $platform`.

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ê–≥—Ä–µ–≥–∞—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –æ –¥–µ—Ç–∞–ª—è—Ö HTTP request
- Platform - –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –¥–µ—Ç–∞–ª—å, –Ω–µ –¥–æ–º–µ–Ω–Ω–∞—è

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–±—ã—Ç–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –ë–ï–ó –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –∞–≥—Ä–µ–≥–∞—Ç–µ
- Platform –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å–µ —á–µ—Ä–µ–∑ `withPlatform()` –º–µ—Ç–æ–¥
- PlatformResolver –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∏–∑ request

**–ö–æ–¥ –≤ —Å–µ—Ä–≤–∏—Å–µ:**
```php
private function storeEvents(UserQuestProgress $progress): void
{
    $platform = $this->platformResolver->resolve();
    $events = $progress->pull();
    
    foreach ($events as $event) {
        $event->withPlatform($platform);
        $this->eventStore->store($event);
    }
}
```

**Lesson:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ - –∞–≥—Ä–µ–≥–∞—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è, —Å–µ—Ä–≤–∏—Å –æ–±–æ–≥–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏.

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –±–µ–∑ PK

**–ü–ª–∞–Ω:** –¢–∞–±–ª–∏—Ü–∞ `domain_events_progress` –ë–ï–ó `id` (PK).

**–ü—Ä–æ–±–ª–µ–º–∞ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è):** 
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ–∂–∏–¥–∞—é—Ç –Ω–∞–ª–∏—á–∏–µ PK
- –°–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π –ë–î
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ

**–†–µ—à–µ–Ω–∏–µ (—Ç–µ–∫—É—â–µ–µ):** –û—Å—Ç–∞–≤–∏–ª–∏ –±–µ–∑ PK —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞:** 
- –î–æ–±–∞–≤–∏—Ç—å `id BIGSERIAL PRIMARY KEY` –≤ –±—É–¥—É—â–µ–º –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π PK: `(aggregate_id, occurred_at, event_type)`

**Lesson:** –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î - —Ö–æ—Ä–æ—à–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞, –Ω–æ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –≤ production.

### 4. JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è platform –∏ event_data

**–í—ã–∑–æ–≤:** –û–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- `platform`: `Platform::toArray()` ‚Üí JSON ‚Üí `Platform::fromArray()` (–ø–æ–∫–∞ –Ω–µ—Ç, —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ array)
- `event_data`: preg_match –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è, –∑–∞—Ç–µ–º new QuestStepCheckEvent(...)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è (event_type).

**–ö–æ–¥ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
```php
private function hydrateEvent(array $row): AbstractUserQuestProgressEvent
{
    $eventType = $row['event_type'];
    $eventData = json_decode($row['event_data'], true);
    
    // Switch –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
    return match ($eventType) {
        QuestStartedEvent::class => new QuestStartedEvent(...),
        QuestStepCheckEvent::class => new QuestStepCheckEvent(...),
        // ...
    };
}
```

**Lesson:** Event Store —Ç—Ä–µ–±—É–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –º–µ–∂–¥—É event_type –∏ –∫–ª–∞—Å—Å–æ–º —Å–æ–±—ã—Ç–∏—è.

---

## üí° –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —É—Ä–æ–∫–∏

### 1. DDD Events - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —á–∏—Å—Ç–æ—Ç–æ–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å—é

**–ß–∏—Å—Ç—ã–π DDD:** –°–æ–±—ã—Ç–∏—è - pure domain objects, –±–µ–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π.

**–ù–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –°–æ–±—ã—Ç–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç `platform` (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—É—é –¥–µ—Ç–∞–ª—å).

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è (web/iOS/Android)
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ metadata) —É—Å–ª–æ–∂–Ω–∏–ª–∞ –±—ã –∑–∞–ø—Ä–æ—Å—ã
- –ö–æ–º–ø—Ä–æ–º–∏—Å—Å: –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å–µ, –Ω–µ –≤ –∞–≥—Ä–µ–≥–∞—Ç–µ

**–í—ã–≤–æ–¥:** –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º > –¥–æ–≥–º–∞—Ç–∏–∑–º –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö.

### 2. Trait vs Abstract Class –¥–ª—è shared behavior

**–í—ã–±–æ—Ä:** Trait –¥–ª—è `RecordsEvents`.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å `AggregateRoot`.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ trait:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–∞–≥—Ä–µ–≥–∞—Ç –º–æ–∂–µ—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–ª–∞—Å—Å)
- –ú–µ–Ω—å—à–µ coupling
- –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ trait:**
- –ù–µ –≤–∏–¥–µ–Ω –≤ type hints (–Ω–µ–ª—å–∑—è `AggregateRoot $aggregate`)
- –¢—Ä–µ–±—É–µ—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

**–í—ã–≤–æ–¥:** –î–ª—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π trait - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.

### 3. Event Store - append-only log

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –¢–æ–ª—å–∫–æ INSERT, –Ω–µ—Ç UPDATE/DELETE.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Immutability - —Å–æ–±—ã—Ç–∏—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è
- Audit trail - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- Performance - –Ω–µ—Ç lock contention –Ω–∞ updates

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –†–∞—Å—Ç—É—â–∏–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å "–∏—Å–ø—Ä–∞–≤–∏—Ç—å" –æ—à–∏–±–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–µ)

**–í—ã–≤–æ–¥:** Append-only log - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è Event Store, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ data retention.

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Event Sourcing

**Unit —Ç–µ—Å—Ç—ã:** –ü—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**Integration —Ç–µ—Å—Ç—ã:** –ü—Ä–æ–≤–µ—Ä—è—é—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ Event Store.

**–ß—Ç–æ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–∞ –∏–∑ —Å–æ–±—ã—Ç–∏–π (—É –Ω–∞—Å –Ω–µ—Ç event sourcing –≤ —á–∏—Å—Ç–æ–º –≤–∏–¥–µ)
- Event handlers / side effects (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

**Lesson:** –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ; –∏–∑–±–µ–≥–∞–µ–º over-engineering —Ç–µ—Å—Ç–æ–≤.

### 5. Documentation-driven development

**–ü–æ–¥—Ö–æ–¥:** README.md –±—ã–ª –Ω–∞–ø–∏—Å–∞–Ω –î–û integration —Ç–µ—Å—Ç–æ–≤.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥—É–º–∞—Ç—å API –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞
- –°–ª—É–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤

**–í—ã–≤–æ–¥:** –ü–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∫–æ–¥–æ–º, –∞ –Ω–µ "–ø–æ—Ç–æ–º".

---

## üîß –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

### 1. –§–∞–∑–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É

**–ú–µ—Ç—Ä–∏–∫–∞:** 4 —Ñ–∞–∑—ã, —á—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.

**–£–ª—É—á—à–µ–Ω–∏–µ –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–¥–∞—á:**
- –í—Å–µ–≥–¥–∞ —Ä–∞–∑–±–∏–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ñ–∞–∑—ã
- –ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–π
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —è–≤–Ω—ã–º–∏

### 2. –†–∞–Ω–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î

**–í —ç—Ç–æ–π –∑–∞–¥–∞—á–µ:** –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ –§–∞–∑–µ 3, –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Event Store.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Integration —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ë–î.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –±—ã–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.

### 3. –ë–æ–Ω—É—Å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–∞–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –±—É–¥—É—â–µ–µ

**PlatformResolver + Platform VO:** –ù–µ –±—ã–ª–∏ –≤ –ø–ª–∞–Ω–µ, –Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –æ–≥—Ä–æ–º–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å.

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤ (Quest analytics, User behavior)
- –õ—É—á—à–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É, —á–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø–æ—Ç–æ–º

**Lesson:** –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ —Å—Ä–∞–∑—É –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ.

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–µ

**–ü–æ–¥—Ö–æ–¥:** –§–∞–∑–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 0 regression bugs –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ñ–∞–∑.

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –§–∞–∑–∞ 1: 4 unit —Ç–µ—Å—Ç–∞
- –§–∞–∑–∞ 2: 8 unit —Ç–µ—Å—Ç–æ–≤
- –§–∞–∑–∞ 3: 7 integration —Ç–µ—Å—Ç–æ–≤
- –§–∞–∑–∞ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã + bugfixes

**–í—ã–≤–æ–¥:** Test-driven approach –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ.

---

## üöÄ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Shared –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `src/Shared/Domain/Event/` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è Event Sourcing –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.

**–í—ã–≥–æ–¥–∞:**
- Quest domain –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- User domain –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RecordsEvents trait
- –õ—é–±–æ–π –Ω–æ–≤—ã–π –¥–æ–º–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç Event Sourcing –∏–∑ –∫–æ—Ä–æ–±–∫–∏

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞.

### 2. DBAL –¥–ª—è Event Store - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:**
- Doctrine ORM: overhead –æ—Ç hydration
- PDO –Ω–∞–ø—Ä—è–º—É—é: —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ

**DBAL - –∑–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞:**
- Type-safe query building
- Transaction support
- –ë–µ–∑ overhead ORM

**Performance impact:** ~1-2ms –Ω–∞ INSERT —Å–æ–±—ã—Ç–∏—è (acceptable –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏).

### 3. JSON columns –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏ —Å—Ö–µ–º—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- `event_data JSONB` - —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- `platform JSONB` - —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª–µ–π
- –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ JSONB –ø–æ–ª–µ–π (PostgreSQL)

**Trade-off:** –°–ª–æ–∂–Ω–µ–µ –¥–µ–ª–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ event_data.

### 4. Value Objects –¥–ª—è type safety

**Platform VO:**
```php
$platform = Platform::web('Chrome', '120.0.0', 'macOS');
// vs
$platform = ['type' => 'web', 'browser' => 'Chrome', ...];
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- PHPStan –≤–∏–¥–∏—Ç —Ç–∏–ø—ã
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π Platform
- Factory –º–µ—Ç–æ–¥—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**Lesson:** Value Objects > associative arrays –¥–ª—è –¥–æ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π.

### 5. PlatformResolver - separation of concerns

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –Ω–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å (374 —Å—Ç—Ä–æ–∫–∏ —Ç–µ—Å—Ç–æ–≤!)
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è User-Agent parsing

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è device capabilities (mobile/desktop, screen size).

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ KPI

### –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –§–∞–∑–∞ | Estimated | Actual | Variance |
|------|-----------|--------|----------|
| –§–ê–ó–ê 1 | 2-3—á | ~2.5—á | ‚úÖ 0% |
| –§–ê–ó–ê 2 | 3-4—á | ~3—á | ‚úÖ -25% |
| –§–ê–ó–ê 3 | 2-3—á | ~2.5—á | ‚úÖ 0% |
| –§–ê–ó–ê 4 | 2-3—á | ~2—á | ‚úÖ -33% |
| **–ò–¢–û–ì–û** | **9-12—á** | **~10—á** | **‚úÖ –í –ø–ª–∞–Ω–µ** |

**–í—ã–≤–æ–¥:** –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –±—ã–ª–∞ —Ç–æ—á–Ω–æ–π. –§–∞–∑–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–ª –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å.

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| PHPStan Level | 5 (max –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞) |
| Test Coverage | Unit: 12 tests, Integration: 7 tests |
| Pass Rate | 100% |
| Lines of Code | ~1200 (–Ω–æ–≤—ã–π –∫–æ–¥) |
| Documentation | 153 —Å—Ç—Ä–æ–∫–∏ (README.md) |
| Regression Bugs | 0 |

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Coupling | Low (Shared ‚Üí Domain, Domain –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Infrastructure) |
| Cohesion | High (–∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å) |
| Reusability | High (RecordsEvents, DomainEventInterface, Platform) |
| Extensibility | High (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è) |

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø–æ—Å–ª–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏)

- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `tasks.md` - —Å—Ç–∞—Ç—É—Å REFLECTION COMPLETE
- ‚è≥ `/archive` - —Å–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤ –∑–∞–¥–∞—á–∏ CQST-010
- ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å `systemPatterns.md` - –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã Event Sourcing

### 2. –ö–æ—Ä–æ—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

**–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Event Sourcing –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–æ–º–µ–Ω—ã:**
- Quest domain: QuestCreatedEvent, QuestPublishedEvent
- User domain: UserRegisteredEvent, ProfileUpdatedEvent

**Event Handlers (side effects):**
- –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ QuestCompletedEvent
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ QuestStartedEvent

**Analytics queries:**
- –ó–∞–ø—Ä–æ—Å—ã –∫ Event Store –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- Dashboards –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π (conversion funnel, completion rate)

### 3. –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –º–µ—Å—è—Ü–∞)

**Event Store optimization:**
- –î–æ–±–∞–≤–∏—Ç—å PK (id BIGSERIAL) –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –¥–∞—Ç–µ (–¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤)
- Archival strategy –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π (>6 –º–µ—Å—è—Ü–µ–≤)

**Event Replay:**
- –ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∏–≥—Ä—ã–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –∏–ª–∏ bugfixes)
- Event versioning (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

**Monitoring & Observability:**
- –ú–µ—Ç—Ä–∏–∫–∏: events/sec, store latency, error rate
- Alerts –Ω–∞ —Å–±–æ–∏ –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π
- Dashboard –¥–ª—è event stream

### 4. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (3-6 –º–µ—Å—è—Ü–µ–≤)

**Event-Driven Architecture:**
- Message broker (RabbitMQ/Kafka) –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- Event subscribers –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö
- CQRS –ø–∞—Ç—Ç–µ—Ä–Ω (read models –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π)

**Machine Learning –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö:**
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–µ—Å—Ç–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–±—ã—Ç–∏–π
- Anomaly detection (–Ω–µ–æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

---

## üèÜ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ

- ‚úÖ –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ DDD –ø—Ä–∏–Ω—Ü–∏–ø–∞–º
- ‚úÖ Event Sourcing infrastructure –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
- ‚úÖ Separation of concerns (Domain ‚Üî Application ‚Üî Infrastructure)

### 2. Code Quality

- ‚úÖ 100% test pass rate
- ‚úÖ 0 regression bugs
- ‚úÖ PHPStan Level 5 (–±–µ–∑ –æ—à–∏–±–æ–∫)
- ‚úÖ Comprehensive documentation

### 3. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å

- ‚úÖ Shared infrastructure –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤
- ‚úÖ RecordsEvents trait —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω
- ‚úÖ PlatformResolver –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤–µ–∑–¥–µ

### 4. –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å

- ‚úÖ –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø–ª–∞–Ω–∞ (10—á –∏–∑ 9-12—á)
- ‚úÖ –í—Å–µ 4 —Ñ–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –ù–µ—Ç scope creep (–∫—Ä–æ–º–µ –±–æ–Ω—É—Å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)

### 5. –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –±—É–¥—É—â–µ–º—É

- ‚úÖ Event Store –≥–æ—Ç–æ–≤ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Event-Driven Architecture

---

## üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–¥–∞—á

### 1. –î–ª—è Level 3-4 –∑–∞–¥–∞—á

- **–í—Å–µ–≥–¥–∞** —Ä–∞–∑–±–∏–≤–∞—Ç—å –Ω–∞ —Ñ–∞–∑—ã (3-5 —Ñ–∞–∑)
- **–í—Å–µ–≥–¥–∞** —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π breakdown –¥–æ –Ω–∞—á–∞–ª–∞ BUILD
- **–í—Å–µ–≥–¥–∞** –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–µ
- **–í—Å–µ–≥–¥–∞** –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π

### 2. –î–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∑–∞–¥–∞—á

- –ù–∞—á–∏–Ω–∞—Ç—å —Å Shared –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Value Objects –¥–ª—è type safety
- DBAL - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è Event Store
- Trait > Abstract Class –¥–ª—è –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ (—Ç–∏–ø–∞ RecordsEvents)

### 3. –î–ª—è DDD –∑–∞–¥–∞—á

- –°–æ–±—ã—Ç–∏—è - immutable –∏ self-contained
- –ê–≥—Ä–µ–≥–∞—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Å–æ–±—ã—Ç–∏—è, —Å–µ—Ä–≤–∏—Å—ã –æ–±–æ–≥–∞—â–∞—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- Event Store - append-only log
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞

### 4. –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–Ω–æ –∏ —á–∞—Å—Ç–æ
- –ù–µ –±–æ—è—Ç—å—Å—è –±–æ–Ω—É—Å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç —Ü–µ–Ω–Ω–æ—Å—Ç—å)
- –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º > –¥–æ–≥–º–∞—Ç–∏–∑–º –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö
- –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ —Ñ–∞–∑—ã –±–æ–ª–µ–µ —Ç–æ—á–Ω–∞, —á–µ–º –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

---

## üéì –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ó–∞–¥–∞—á–∞ CQST-010 –±—ã–ª–∞ **—É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞** —Å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ–º –æ–∂–∏–¥–∞–Ω–∏–π:

- ‚úÖ –í—Å–µ —Ü–µ–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã
- ‚úÖ –ë–æ–Ω—É—Å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ –í—Ä–µ–º—è –≤ —Ä–∞–º–∫–∞—Ö –ø–ª–∞–Ω–∞
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

**–ö–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç:** –§–∞–∑–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ = –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∑–∞–¥–∞—á.

**ROI:** –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ Event Sourcing –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–∫—É–ø–∏—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π –≤ –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–∞—Ö (Quest, User, Achievement).

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ Event-Driven Architecture –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π.

---

**Reflection –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** 2025-12-28  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** `/archive` –¥–ª—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ CQST-010

